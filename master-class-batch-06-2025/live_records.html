<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Recorded Classes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase shared init -->
<script type="module" src="firebase-config.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#f4f7fb;
  color:#0f172a;
}

/* HEADER */
header{
  background:#0a1a32;
  color:#fff;
  padding:1rem 1.5rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header a{
  color:#22c55e;
  text-decoration:none;
  font-weight:600;
}

/* LAYOUT */
.container{
  max-width:1200px;
  margin:auto;
  padding:2rem 1.5rem;
}
h2{
  margin-bottom:1.2rem;
}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:1.2rem;
}
.card{
  background:#fff;
  border-radius:16px;
  padding:1.2rem;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
.card.locked{
  opacity:.6;
}
.card h3{
  margin:.5rem 0 .4rem;
}
iframe{
  width:100%;
  height:200px;
  border-radius:12px;
  border:none;
}
.lock{
  text-align:center;
  padding:2rem 1rem;
  background:#f1f5f9;
  border-radius:12px;
  font-weight:600;
  color:#dc2626;
}

/* LOADING */
.loading{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#64748b;
  font-size:1.05rem;
}
</style>
</head>

<body>

<!-- LOADING -->
<div id="loading" class="loading">
  Loading live recorded classesâ€¦
</div>

<!-- CONTENT -->
<div id="content" style="display:none">

<header>
  <strong>Live Recorded Classes</strong>
  <a href="masterclass_index.html">â¬… Back</a>
</header>

<div class="container">
  <h2>Available Sessions</h2>
  <div id="grid" class="grid"></div>
</div>

</div>

<script type="module">
import { onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection, getDocs, doc, getDoc, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const auth = window.auth;
const db = window.db;

/* ðŸ”‘ COURSE ID â€” MUST MATCH ADMIN + RULES */
const COURSE_ID = "masterclass_batch_06_2025";

const grid = document.getElementById("grid");
const loading = document.getElementById("loading");
const content = document.getElementById("content");

/* AUTH + PAID CHECK */
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    location.href="masterclass_login.html";
    return;
  }

  const userSnap = await getDoc(doc(db,"users",user.uid));
  const paid = userSnap.exists() && userSnap.data().paid === true;

  loadClasses(paid);
});

/* LOAD CLASSES */
async function loadClasses(isPaid){
  try{
    const q = query(
      collection(db, "courses", COURSE_ID, "live_record_classes"),
      orderBy("order","asc")
    );

    const snap = await getDocs(q);
    grid.innerHTML="";

    if(snap.empty){
      grid.innerHTML = `
        <div style="
          grid-column:1/-1;
          text-align:center;
          padding:2rem;
          color:#64748b">
          No live recorded classes available yet.
        </div>`;
    }

    snap.forEach(d=>{
      const x = d.data();
      const locked = x.locked && !isPaid;

      grid.innerHTML += `
        <div class="card ${locked ? "locked":""}">
          <h3>${x.title}</h3>
          ${
            locked
            ? `<div class="lock">
                 ðŸ”’ This class is locked.<br>
                 Purchase the course to unlock.
               </div>`
            : `<iframe src="${x.videoUrl}" allowfullscreen></iframe>`
          }
        </div>`;
    });

  }catch(err){
    console.error("Live Records Load Error:", err);
    grid.innerHTML = `
      <div style="
        grid-column:1/-1;
        text-align:center;
        padding:2rem;
        color:#dc2626">
        Error loading live recorded classes.
      </div>`;
  }

  /* ALWAYS EXIT LOADING */
  loading.style.display="none";
  content.style.display="block";
}
</script>

</body>
</html>
