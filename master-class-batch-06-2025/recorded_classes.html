<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Recorded Classes ‚Äì PT Experts</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module" src="firebase-config.js"></script>

<style>
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#f4f7fb}

/* HEADER */
header{
  background:#0a1a32;color:#fff;
  padding:1rem 1.5rem;
  display:flex;justify-content:space-between;align-items:center
}
header a{color:#22c55e;font-weight:600;text-decoration:none}

/* LAYOUT */
.container{max-width:1000px;margin:auto;padding:1.5rem}

/* PROGRESS */
.progress{
  background:#fff;padding:1rem 1.2rem;border-radius:12px;
  margin-bottom:18px;box-shadow:0 6px 18px rgba(0,0,0,.08)
}

/* LIST */
.list{display:flex;flex-direction:column;gap:14px}
.item{
  background:#fff;padding:1rem 1.2rem;border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  display:flex;justify-content:space-between;align-items:center
}
.item.locked{opacity:.5}

/* BADGES */
.badge{padding:4px 10px;border-radius:20px;font-size:.75rem;font-weight:600}
.badge.completed{background:#dcfce7;color:#166534}
.badge.available{background:#e0f2fe;color:#075985}
.badge.locked{background:#fde68a;color:#92400e}

/* BUTTON */
.play{
  padding:6px 16px;
  border-radius:8px;
  border:none;
  font-weight:700;
  cursor:pointer;
}
.play:hover{
  opacity:.9;
}

.play.play{background:#22c55e;color:#fff}
.play.rewatch{background:#2563eb;color:#fff}
.play.locked{background:#e5e7eb}

/* PLAYER */
#playerBox{
  margin-top:30px;background:#fff;padding:1rem;
  border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08)
}
iframe{width:100%;height:420px;border:none;border-radius:12px}

.finishBtn{
  margin-top:12px;padding:.7rem 1.2rem;
  background:#16a34a;color:#fff;border:none;
  border-radius:10px;font-weight:700;cursor:pointer
}

.loading{
  min-height:60vh;display:flex;
  align-items:center;justify-content:center;color:#64748b
}
</style>
</head>

<body>

<header>
  <a href="masterclass_index.html">‚Üê Back</a>
  <strong>Recorded Classes</strong>
</header>

<div class="container">

  <div id="progress" class="progress"></div>

  <div id="loading" class="loading">Loading classes‚Ä¶</div>
  <div id="list" class="list"></div>

  <!-- PLAYER -->
  <div id="playerBox" style="display:none">
    <h3 id="videoTitle"></h3>
    <iframe id="player" allowfullscreen></iframe>
    <button id="finishBtn" class="finishBtn">
      ‚úÖ Finished Watching
    </button>
  </div>

</div>

<script type="module">
import { onAuthStateChanged } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection,getDocs,doc,getDoc,updateDoc,query,orderBy
} from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const auth=window.auth, db=window.db;
const COURSE_ID="masterclass_batch_06_2025";

let currentUserId=null;
let currentVideoId=null;

const list=document.getElementById("list");
const loading=document.getElementById("loading");
const progress=document.getElementById("progress");
const finishBtn=document.getElementById("finishBtn");

/* AUTH */
onAuthStateChanged(auth, async user=>{
  if(!user) return location.href="masterclass_login.html";
  currentUserId=user.uid;

  const u=await getDoc(doc(db,"users",user.uid));
  if(!u.exists()||u.data().paid!==true)
    return location.href="masterclass_login.html";

  loadVideos();
});

/* LOAD VIDEOS */
async function loadVideos(){
  list.innerHTML="";
  loading.style.display="flex";

  const q=query(
    collection(db,"courses",COURSE_ID,"recorded_classes"),
    orderBy("order","asc")
  );
  const snap=await getDocs(q);

  let allowNext=true, completedCount=0;

  snap.forEach(d=>{
    const v=d.data();
    const done=v.completedBy?.includes(currentUserId);
    if(done) completedCount++;

    let state="locked";
    if(done) state="completed";
    else if(allowNext) state="available";

    if(!done && allowNext) allowNext=false;

    const row=document.createElement("div");
    row.className=`item ${state==="locked"?"locked":""}`;
    row.innerHTML=`
      <div>
        <strong>${v.title}</strong><br>
        <span class="badge ${state}">
          ${state==="completed"?"Completed":state==="available"?"Available":"Locked"}
        </span>
      </div>
      <button class="play ${state==="completed"?"rewatch":state==="available"?"play":"locked"}">
        ${state==="completed"?"Rewatch":state==="available"?"Play":"üîí"}
      </button>
    `;

    if(state!=="locked"){
      row.querySelector("button").onclick=()=>{
        playVideo(d.id,v.title,v.videoUrl,done);
      };
    }

    list.appendChild(row);
  });

  const percent = Math.round((completedCount / snap.size) * 100);

progress.innerHTML = `
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <strong>Progress</strong>
    <span>${completedCount} / ${snap.size} (${percent}%)</span>
  </div>

  <div style="background:#e5e7eb;height:10px;border-radius:20px;overflow:hidden">
    <div style="
      width:${percent}%;
      height:100%;
      background:#22c55e;
      transition:width .3s ease">
    </div>
  </div>
`;


  loading.style.display="none";
}

/* PLAY VIDEO */
function playVideo(id,title,embedUrl,completed){
  currentVideoId=id;
  document.getElementById("videoTitle").innerText=title;
  document.getElementById("player").src=embedUrl;
  document.getElementById("playerBox").style.display="block";

  finishBtn.style.display=completed?"none":"inline-block";

  window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"});
}

/* FINISHED WATCHING */
finishBtn.onclick=async()=>{
  if(!currentVideoId) return;

  const ref=doc(db,"courses",COURSE_ID,"recorded_classes",currentVideoId);
  const snap=await getDoc(ref);
  const done=snap.data().completedBy||[];

  if(!done.includes(currentUserId)){
    await updateDoc(ref,{completedBy:[...done,currentUserId]});
  }

  finishBtn.style.display="none";
  loadVideos();
};
</script>

</body>
</html>
