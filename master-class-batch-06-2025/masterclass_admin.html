<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel â€“ PT Experts Masterclass</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ðŸ”¥ Firebase init (ONLY ONCE, shared) -->
<script type="module" src="firebase-config.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#f4f7fb;
}
header{
  background:#0a1a32;
  color:#fff;
  padding:1rem 1.5rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:1.5rem;
}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:12px;
  overflow:hidden;
}
th,td{
  padding:.8rem;
  border-bottom:1px solid #e2e8f0;
  text-align:left;
}
th{background:#f1f5f9}
button{
  padding:.4rem .8rem;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}
.approve{background:#22c55e;color:#fff}
.revoke{background:#ef4444;color:#fff}
.logout{cursor:pointer;color:#facc15;font-weight:600}
.loading{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.1rem;
}
</style>
</head>

<body>

<!-- LOADING -->
<div id="loading" class="loading">Checking admin accessâ€¦</div>

<!-- ADMIN PANEL -->
<div id="panel" style="display:none">

<header>
  <h3>Masterclass Admin Panel</h3>

  <div style="display:flex; gap:15px; align-items:center;">
    <a href="masterclass_index.html"
       target="_blank"
       style="
         color:#22c55e;
         font-weight:600;
         text-decoration:none;
         cursor:pointer;
       ">
      ðŸ‘¤ Master Class Page
    </a>

    <span class="logout" onclick="logout()">Logout</span>
  </div>
</header>

<div class="container">
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Paid</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="userRows"></tbody>
  </table>
</div>

</div>

<!-- ðŸ”¥ ADMIN LOGIC -->
<script type="module">
  import { onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection,
    getDocs,
    doc,
    getDoc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const auth = window.auth;
  const db = window.db;

  // ADMIN CHECK
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "masterclass_login.html";
      return;
    }

    try {
      const adminSnap = await getDoc(doc(db, "admins", user.uid));
      if (!adminSnap.exists()) {
        alert("Admin access only");
        location.href = "masterclass_index.html";
        return;
      }

      document.getElementById("loading").style.display = "none";
      document.getElementById("panel").style.display = "block";
      loadUsers();

    } catch (e) {
      console.error(e);
      location.href = "masterclass_index.html";
    }
  });

  // LOAD USERS
  async function loadUsers() {
    const rows = document.getElementById("userRows");
    rows.innerHTML = "";

    const snap = await getDocs(collection(db, "users"));
    snap.forEach(docu => {
      const u = docu.data();
      rows.innerHTML += `
        <tr>
          <td>${u.name || "-"}</td>
          <td>${u.email}</td>
          <td>${u.paid ? "Yes" : "No"}</td>
          <td>
            ${
              u.paid
                ? `<button class="revoke" onclick="setPaid('${docu.id}',false)">Revoke</button>`
                : `<button class="approve" onclick="setPaid('${docu.id}',true)">Approve</button>`
            }
          </td>
        </tr>
      `;
    });
  }

  // UPDATE PAID STATUS
  window.setPaid = async (uid, val) => {
    await updateDoc(doc(db, "users", uid), { paid: val });
    loadUsers();
  };

  // LOGOUT
  window.logout = async () => {
    await signOut(auth);
    location.href = "masterclass_login.html";
  };
</script>

</body>
</html>
